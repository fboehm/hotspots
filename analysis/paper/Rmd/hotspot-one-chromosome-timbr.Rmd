## Chr {{hot_chr}}


```{r, def-{{hot_chr}}}
hot_lower <- {{hot_mid}} - 2
hot_upper <- {{hot_mid}} + 2
```

```{r, define_hot_annot-{{hot_chr}}}
hot_annot <- lod_peaks %>%
  dplyr::filter(chrom == {{hot_chr}}, pos <= hot_upper, pos >= hot_lower) %>%
  dplyr::left_join(y = annots, by = c("annot.id" = "gene_id")) %>%
  dplyr::filter(!duplicated(annot.id)) %>%
  dplyr::filter(lod >= 7.18) %>%
  dplyr::mutate(local_tx = chr == {{hot_chr}}) %>%
  dplyr::filter((!local_tx) | (lod >= ult & middle <= hot_upper & middle >= hot_lower))
```


```{r hot_expr-{{hot_chr}}}
hot_expr <- expr[, colnames(expr) %in% hot_annot$annot.id]
```


### TIMBR analyses


```{r}
fn <- "attie_DO500_genoprobs_v5_36state_chr{{hot_chr}}.rds"
gp <- readRDS(here::here("analysis", "data", "derived_data", fn))
```


```{r}
library(future)
options(future.globals.maxSize= 10 * 1024 ^ 3)
```

```{r, timbr-{{hot_chr}}}
set.seed(3411192) # to ensure getting the same samples with TIMBR
future::plan("multiprocess")
t_out <- hot_annot %>%
  dplyr::mutate(timbr = furrr::future_pmap(.l = list(annot.id, marker.id), .f = function(annot.id, marker.id){
    phe_pre <- hot_expr[ , colnames(hot_expr) == annot.id, drop = FALSE]
    phe <- phe_pre[!is.na(phe_pre), , drop = FALSE]
    pr_pre <- gp[[1]][, , marker.id] # use first (and only!) entry in gp
    pr <- pr_pre[rownames(pr_pre) %in% rownames(phe), ]
    cov_pre <- cbind(1, covar)
    cov_pre2 <- cov_pre[rownames(cov_pre) %in% rownames(phe), ]
    cov <- qtl2:::drop_depcols(cov_pre2)
    TIMBR::TIMBR(y = phe, 
                 prior.D = list(P = pr, 
                                A = mcv.data$prior.D$A, # works for autosomes
                                fixed.diplo = FALSE), 
                 prior.M = prior_M1, 
                 samples = 10000, 
                 samples.ml = 10000,
                 Z = cov, 
                 verbose = TRUE
                 )  
}))
dim(t_out)
saveRDS(t_out, here::here("analysis", "data", "derived_data", "timbr-chr{{hot_chr}}-10ksamples-M1.rds"))
```



