---
title: "Heatmaps of pleiotropy test statistics - all traits"
author: "Frederick Boehm"
date: "7/15/2019"
output: 
  html_document:
    toc: true
    code_folding: hide
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(hotspots)
pleio_threshold <- 4
```

Below, we produce heatmaps for every hotspot. We consider, for every hotspot, all local and nonlocal traits with univariate LOD at least 7.18, which is the genomewide threshold that Keller et al identified via permutations.


# Chr 2

```{r setup_continued-2}
hot_chr <- 2
hot_mid <- 165.5
```

```{r more_setup-2}
hot_lower <- hot_mid - 2
hot_upper <- hot_mid + 2
fp <- paste0("../figures/Chr", hot_chr, "-")
knitr::opts_chunk$set(fig.path = fp)
```




## Reading intermediate result files 

Let's examine the Chr `r hot_chr` files for pleiotropy results.

```{r readRDS-2}
pleio_mixed_list <- readRDS(paste0("_cache/Chr", hot_chr, "_pleio.rds"))
pleio_local_list <- readRDS(paste0("_cache/Chr", hot_chr, "_pleio_local.rds"))
pleio_nonlocal_list <- readRDS(paste0("_cache/Chr", hot_chr, "_pleio_nonlocal.rds"))
med_list <- readRDS(paste0("_cache/Chr", hot_chr, "_mediations.rds"))
```

```{r, load_attie}
load("~/Box Sync/attie/keller2018-chr2-hotspot-chtc/data-to-ignore/Attie_DO378_eQTL_viewer_v1.Rdata")
library(tidyverse)
options(tibble.print_max = 50, tibble.print_min = 20)
```


```{r make_local_annot-2}
local_annot <- dataset.islet.rnaseq$lod.peaks %>%
  filter(chrom == hot_chr, pos <= hot_upper, pos >= hot_lower) %>%
  left_join(y = dataset.islet.rnaseq$annots, by = c("annot.id" = "gene_id")) %>%
  filter(!duplicated(annot.id)) %>%
  filter(lod >= 7.18) %>%
  mutate(local_tx = chr == hot_chr) %>%
  filter(local_tx)
```


```{r make_nonlocal_annot-2}
nonlocal_annot <- dataset.islet.rnaseq$lod.peaks %>%
  filter(chrom == hot_chr, pos <= hot_upper, pos >= hot_lower) %>%
  left_join(y = dataset.islet.rnaseq$annots, by = c("annot.id" = "gene_id")) %>%
  filter(!duplicated(annot.id)) %>%
  filter(lod >= 7.18) %>% #genomewide threshold
  mutate(local_tx = chr == hot_chr) %>%
  filter(!local_tx) %>% 
  filter(!is.na(hotspot))
```


```{r, make_local_annot2-2}
local_annot2 <- local_annot %>%
  filter(middle <= hot_upper + 5, middle >= hot_lower - 5) %>%
  arrange(desc(lod))
```

```{r subset_expr_matrix-2}
hot_local <- dataset.islet.rnaseq$expr[, colnames(dataset.islet.rnaseq$expr) %in% local_annot2$annot.id]
hot_nonlocal <- dataset.islet.rnaseq$expr[, colnames(dataset.islet.rnaseq$expr) %in% nonlocal_annot$annot.id]
nnonlocal <- ncol(hot_nonlocal)
nlocal <- ncol(hot_local)
```




```{r tabulate-2, message=FALSE, warning = FALSE}
med_tib <- med_list %>%
  purrr::map(bind_rows) %>%
  bind_rows() %>%
  as_tibble() %>%
  rename(lod_without_med = lod_no_med, lod_with_med = lod_med) %>%
  mutate(lod_diff = lod_without_med - lod_with_med, lod_diff_proportion = lod_diff / lod_without_med) %>%
  mutate(local_gene_id = rep(colnames(hot_local), each = nnonlocal), nonlocal_gene_id = rep(colnames(hot_nonlocal), times = nlocal)) %>%
  left_join(local_annot2, by = c("local_gene_id" = "annot.id")) %>%
  left_join(nonlocal_annot, by = c("nonlocal_gene_id" = "annot.id")) %>%
  dplyr::select(symbol.x, symbol.y, lod_without_med, lod_with_med, lod_diff, lod_diff_proportion, local_gene_id, nonlocal_gene_id) %>%
  rename(local_symbol = symbol.x, nonlocal_symbol = symbol.y)
```






```{r make_pleio_tib-2}
hot_annot <- local_annot2 %>%
  bind_rows(nonlocal_annot) %>%
  select(annot.id, symbol)
(pleio_tib <- pleio_mixed_list %>%
  purrr::map(.f = function(x) rename(x, gene1_id = local_gene_id, gene2_id = nonlocal_gene_id)) %>%
  c(pleio_local_list, pleio_nonlocal_list) %>%
  bind_rows() %>%
  rename(pleiotropy_lod = lod) %>%
  left_join(hot_annot, by = c("gene1_id" = "annot.id")) %>%
  rename(gene1_symbol = symbol) %>%
  left_join(hot_annot, by = c("gene2_id" = "annot.id")) %>%
  rename(gene2_symbol = symbol) %>%
  select(gene1_symbol, gene2_symbol, pleiotropy_lod)
)  
```

```{r make_pm-2}
pm <- pleio_tib %>%
  tibble_to_matrix(symmetric = TRUE)
```


## heatmaps for full matrix


```{r load_heatmaply}
library(heatmaply)
```

```{r make_scols-2}
scols <- 1L + (rownames(pm) %in% local_annot2$symbol)
```


The vignette for `heatmaply` is quite helpful and includes discussion of its methods for ordering rows.

```{r heat-pleio-2}
heatmaply(pm, symm = TRUE, cexRow = 0.2, cexCol = 0.2, row_side_colors = scols)
```


```{r heat2-2}
heatmaply(pm, cexRow = 0.2, cexCol = 0.2, seriate = "mean", symm = TRUE, row_side_colors = scols)
```

```{r heat3-2}
(pm > pleio_threshold) %>%
  apply(FUN = as.integer, MARGIN = 2) %>%
  (function(x) {rownames(x) <- colnames(x); return(x)}) %>%
  heatmaply(cexRow = 0.2, cexCol = 0.2, symm = TRUE, row_side_colors = scols)
```

```{r heat4-2}
(pm > pleio_threshold) %>%
  apply(FUN = as.integer, MARGIN = 2) %>%
  (function(x) {rownames(x) <- colnames(x); return(x)}) %>%
  heatmaply(cexRow = 0.2, cexCol = 0.2, symm = TRUE, seriate = "mean", row_side_colors = scols)
```





## Heatmaps for matrix containing only nonlocal traits

```{r heat5-2}
pm_nonlocal <- pleio_tib %>%
  filter(gene1_symbol %in% nonlocal_annot$symbol, gene2_symbol %in% nonlocal_annot$symbol) %>%
  tibble_to_matrix(symmetric = TRUE)
pm_nonlocal %>%
  heatmaply(symm = TRUE, cexRow = 0.3, cexCol = 0.3)

```

```{r heat6-2}
(pm_nonlocal > pleio_threshold) %>%
  apply(FUN = as.integer, MARGIN = 2) %>%
  (function(x) {rownames(x) <- colnames(x); return(x)}) %>%
  heatmaply(symm = TRUE, cexRow = 0.3, cexCol = 0.3)
```

# Chr 5

```{r setup_continued-5}
hot_chr <- 5
hot_mid <- 146
```

```{r more_setup-5}
hot_lower <- hot_mid - 2
hot_upper <- hot_mid + 2
fp <- paste0("../figures/Chr", hot_chr, "-")
knitr::opts_chunk$set(fig.path = fp)
```

## Reading intermediate result files 

Let's examine the Chr `r hot_chr` files for pleiotropy results.

```{r readRDS-5}
pleio_mixed_list <- readRDS(paste0("_cache/Chr", hot_chr, "_pleio.rds"))
pleio_local_list <- readRDS(paste0("_cache/Chr", hot_chr, "_pleio_local.rds"))
pleio_nonlocal_list <- readRDS(paste0("_cache/Chr", hot_chr, "_pleio_nonlocal.rds"))
med_list <- readRDS(paste0("_cache/Chr", hot_chr, "_mediations.rds"))
```



```{r make_local_annot-5}
local_annot <- dataset.islet.rnaseq$lod.peaks %>%
  filter(chrom == hot_chr, pos <= hot_upper, pos >= hot_lower) %>%
  left_join(y = dataset.islet.rnaseq$annots, by = c("annot.id" = "gene_id")) %>%
  filter(!duplicated(annot.id)) %>%
  filter(lod >= 7.18) %>%
  mutate(local_tx = chr == hot_chr) %>%
  filter(local_tx)
```


```{r make_nonlocal_annot-5}
nonlocal_annot <- dataset.islet.rnaseq$lod.peaks %>%
  filter(chrom == hot_chr, pos <= hot_upper, pos >= hot_lower) %>%
  left_join(y = dataset.islet.rnaseq$annots, by = c("annot.id" = "gene_id")) %>%
  filter(!duplicated(annot.id)) %>%
  filter(lod >= 7.18) %>% #genomewide threshold
  mutate(local_tx = chr == hot_chr) %>%
  filter(!local_tx) %>% 
  filter(!is.na(hotspot))
```


```{r, make_local_annot2-5}
local_annot2 <- local_annot %>%
  filter(middle <= hot_upper + 5, middle >= hot_lower - 5) %>%
  arrange(desc(lod))
```

```{r subset_expr_matrix-5}
hot_local <- dataset.islet.rnaseq$expr[, colnames(dataset.islet.rnaseq$expr) %in% local_annot2$annot.id]
hot_nonlocal <- dataset.islet.rnaseq$expr[, colnames(dataset.islet.rnaseq$expr) %in% nonlocal_annot$annot.id]
nnonlocal <- ncol(hot_nonlocal)
nlocal <- ncol(hot_local)
```




```{r tabulate-5, message=FALSE, warning = FALSE}
med_tib <- med_list %>%
  purrr::map(bind_rows) %>%
  bind_rows() %>%
  as_tibble() %>%
  rename(lod_without_med = lod_no_med, lod_with_med = lod_med) %>%
  mutate(lod_diff = lod_without_med - lod_with_med, lod_diff_proportion = lod_diff / lod_without_med) %>%
  mutate(local_gene_id = rep(colnames(hot_local), each = nnonlocal), nonlocal_gene_id = rep(colnames(hot_nonlocal), times = nlocal)) %>%
  left_join(local_annot2, by = c("local_gene_id" = "annot.id")) %>%
  left_join(nonlocal_annot, by = c("nonlocal_gene_id" = "annot.id")) %>%
  dplyr::select(symbol.x, symbol.y, lod_without_med, lod_with_med, lod_diff, lod_diff_proportion, local_gene_id, nonlocal_gene_id) %>%
  rename(local_symbol = symbol.x, nonlocal_symbol = symbol.y)
```






```{r make_pleio_tib-5}
hot_annot <- local_annot2 %>%
  bind_rows(nonlocal_annot) %>%
  select(annot.id, symbol)
(pleio_tib <- pleio_mixed_list %>%
  purrr::map(.f = function(x) rename(x, gene1_id = local_gene_id, gene2_id = nonlocal_gene_id)) %>%
  c(pleio_local_list, pleio_nonlocal_list) %>%
  bind_rows() %>%
  rename(pleiotropy_lod = lod) %>%
  left_join(hot_annot, by = c("gene1_id" = "annot.id")) %>%
  rename(gene1_symbol = symbol) %>%
  left_join(hot_annot, by = c("gene2_id" = "annot.id")) %>%
  rename(gene2_symbol = symbol) %>%
  select(gene1_symbol, gene2_symbol, pleiotropy_lod)
)  
```

```{r make_pm-5}
pm <- pleio_tib %>%
  tibble_to_matrix(symmetric = TRUE)
```


## heatmaps for full matrix

```{r make_scols-5}
scols <- 1L + (rownames(pm) %in% local_annot2$symbol)
```


```{r heat-pleio-5}
heatmaply(pm, symm = TRUE, cexRow = 0.2, cexCol = 0.2, row_side_colors = scols)
```


```{r heat2-5}
heatmaply(pm, cexRow = 0.2, cexCol = 0.2, seriate = "mean", symm = TRUE, row_side_colors = scols)
```

```{r heat3-5}
(pm > pleio_threshold) %>%
  apply(FUN = as.integer, MARGIN = 2) %>%
  (function(x) {rownames(x) <- colnames(x); return(x)}) %>%
  heatmaply(cexRow = 0.2, cexCol = 0.2, symm = TRUE, row_side_colors = scols)
```

```{r heat4-5}
(pm > pleio_threshold) %>%
  apply(FUN = as.integer, MARGIN = 2) %>%
  (function(x) {rownames(x) <- colnames(x); return(x)}) %>%
  heatmaply(cexRow = 0.2, cexCol = 0.2, symm = TRUE, seriate = "mean", row_side_colors = scols)
```


## Heatmaps for matrix containing only nonlocal traits

```{r heat5-5}
pm_nonlocal <- pleio_tib %>%
  filter(gene1_symbol %in% nonlocal_annot$symbol, gene2_symbol %in% nonlocal_annot$symbol) %>%
  tibble_to_matrix(symmetric = TRUE)
pm_nonlocal %>%
  heatmaply(symm = TRUE, cexRow = 0.3, cexCol = 0.3)

```

```{r heat6-5}
(pm_nonlocal > pleio_threshold) %>%
  apply(FUN = as.integer, MARGIN = 2) %>%
  (function(x) {rownames(x) <- colnames(x); return(x)}) %>%
  heatmaply(symm = TRUE, cexRow = 0.3, cexCol = 0.3)
```

# Chr 7

```{r setup_continued-7}
hot_chr <- 7
hot_mid <- 46
```

```{r more_setup-7}
hot_lower <- hot_mid - 2
hot_upper <- hot_mid + 2
fp <- paste0("../figures/Chr", hot_chr, "-")
knitr::opts_chunk$set(fig.path = fp)
```

## Reading intermediate result files 

Let's examine the Chr `r hot_chr` files for pleiotropy results.

```{r readRDS-7}
pleio_mixed_list <- readRDS(paste0("_cache/Chr", hot_chr, "_pleio.rds"))
pleio_local_list <- readRDS(paste0("_cache/Chr", hot_chr, "_pleio_local.rds"))
pleio_nonlocal_list <- readRDS(paste0("_cache/Chr", hot_chr, "_pleio_nonlocal.rds"))
med_list <- readRDS(paste0("_cache/Chr", hot_chr, "_mediations.rds"))
```



```{r make_local_annot-7}
local_annot <- dataset.islet.rnaseq$lod.peaks %>%
  filter(chrom == hot_chr, pos <= hot_upper, pos >= hot_lower) %>%
  left_join(y = dataset.islet.rnaseq$annots, by = c("annot.id" = "gene_id")) %>%
  filter(!duplicated(annot.id)) %>%
  filter(lod >= 7.18) %>%
  mutate(local_tx = chr == hot_chr) %>%
  filter(local_tx)
```


```{r make_nonlocal_annot-7}
nonlocal_annot <- dataset.islet.rnaseq$lod.peaks %>%
  filter(chrom == hot_chr, pos <= hot_upper, pos >= hot_lower) %>%
  left_join(y = dataset.islet.rnaseq$annots, by = c("annot.id" = "gene_id")) %>%
  filter(!duplicated(annot.id)) %>%
  filter(lod >= 7.18) %>% #genomewide threshold
  mutate(local_tx = chr == hot_chr) %>%
  filter(!local_tx) %>% 
  filter(!is.na(hotspot))
```


```{r, make_local_annot2-7}
local_annot2 <- local_annot %>%
  filter(middle <= hot_upper + 5, middle >= hot_lower - 5) %>%
  arrange(desc(lod))
```

```{r subset_expr_matrix-7}
hot_local <- dataset.islet.rnaseq$expr[, colnames(dataset.islet.rnaseq$expr) %in% local_annot2$annot.id]
hot_nonlocal <- dataset.islet.rnaseq$expr[, colnames(dataset.islet.rnaseq$expr) %in% nonlocal_annot$annot.id]
nnonlocal <- ncol(hot_nonlocal)
nlocal <- ncol(hot_local)
```




```{r tabulate-7, message=FALSE, warning = FALSE}
med_tib <- med_list %>%
  purrr::map(bind_rows) %>%
  bind_rows() %>%
  as_tibble() %>%
  rename(lod_without_med = lod_no_med, lod_with_med = lod_med) %>%
  mutate(lod_diff = lod_without_med - lod_with_med, lod_diff_proportion = lod_diff / lod_without_med) %>%
  mutate(local_gene_id = rep(colnames(hot_local), each = nnonlocal), nonlocal_gene_id = rep(colnames(hot_nonlocal), times = nlocal)) %>%
  left_join(local_annot2, by = c("local_gene_id" = "annot.id")) %>%
  left_join(nonlocal_annot, by = c("nonlocal_gene_id" = "annot.id")) %>%
  dplyr::select(symbol.x, symbol.y, lod_without_med, lod_with_med, lod_diff, lod_diff_proportion, local_gene_id, nonlocal_gene_id) %>%
  rename(local_symbol = symbol.x, nonlocal_symbol = symbol.y)
```






```{r make_pleio_tib-7}
hot_annot <- local_annot2 %>%
  bind_rows(nonlocal_annot) %>%
  select(annot.id, symbol)
(pleio_tib <- pleio_mixed_list %>%
  purrr::map(.f = function(x) rename(x, gene1_id = local_gene_id, gene2_id = nonlocal_gene_id)) %>%
  c(pleio_local_list, pleio_nonlocal_list) %>%
  bind_rows() %>%
  rename(pleiotropy_lod = lod) %>%
  left_join(hot_annot, by = c("gene1_id" = "annot.id")) %>%
  rename(gene1_symbol = symbol) %>%
  left_join(hot_annot, by = c("gene2_id" = "annot.id")) %>%
  rename(gene2_symbol = symbol) %>%
  select(gene1_symbol, gene2_symbol, pleiotropy_lod)
)  
```

```{r make_pm-7}
pm <- pleio_tib %>%
  tibble_to_matrix(symmetric = TRUE)
```



## heatmaps for full matrix

```{r make_scols-7}
scols <- 1L + (rownames(pm) %in% local_annot2$symbol)
```

```{r heat-pleio-7}
heatmaply(pm, symm = TRUE, cexRow = 0.2, cexCol = 0.2)
```


```{r heat2-7}
heatmaply(pm, cexRow = 0.2, cexCol = 0.2, seriate = "mean", symm = TRUE)
```

```{r heat3-7}
(pm > pleio_threshold) %>%
  apply(FUN = as.integer, MARGIN = 2) %>%
  (function(x) {rownames(x) <- colnames(x); return(x)}) %>%
  heatmaply(cexRow = 0.2, cexCol = 0.2, symm = TRUE)
```

```{r heat4-7}
(pm > pleio_threshold) %>%
  apply(FUN = as.integer, MARGIN = 2) %>%
  (function(x) {rownames(x) <- colnames(x); return(x)}) %>%
  heatmaply(cexRow = 0.2, cexCol = 0.2, symm = TRUE, seriate = "mean")
```


## Heatmaps for matrix containing only nonlocal traits

```{r heat5-7}
pm_nonlocal <- pleio_tib %>%
  filter(gene1_symbol %in% nonlocal_annot$symbol, gene2_symbol %in% nonlocal_annot$symbol) %>%
  tibble_to_matrix(symmetric = TRUE)
pm_nonlocal %>%
  heatmaply(symm = TRUE, cexRow = 0.3, cexCol = 0.3)

```

```{r heat6-7}
(pm_nonlocal > pleio_threshold) %>%
  apply(FUN = as.integer, MARGIN = 2) %>%
  (function(x) {rownames(x) <- colnames(x); return(x)}) %>%
  heatmaply(symm = TRUE, cexRow = 0.3, cexCol = 0.3)
```





# Chr 11

```{r setup_continued-11}
hot_chr <- 11
hot_mid <- 71
```

```{r more_setup-11}
hot_lower <- hot_mid - 2
hot_upper <- hot_mid + 2
fp <- paste0("../figures/Chr", hot_chr, "-")
knitr::opts_chunk$set(fig.path = fp)
```

## Reading intermediate result files 

Let's examine the Chr `r hot_chr` files for pleiotropy results.

```{r readRDS-11}
pleio_mixed_list <- readRDS("_cache/Chr11_pleio.rds")
pleio_local_list <- readRDS("_cache/Chr11_pleio_local.rds")
pleio_nonlocal_list <- readRDS("_cache/Chr11_pleio_nonlocal.rds")
med_list <- readRDS("_cache/Chr11_mediations.rds")
```



```{r make_local_annot-11}
local_annot <- dataset.islet.rnaseq$lod.peaks %>%
  filter(chrom == hot_chr, pos <= hot_upper, pos >= hot_lower) %>%
  left_join(y = dataset.islet.rnaseq$annots, by = c("annot.id" = "gene_id")) %>%
  filter(!duplicated(annot.id)) %>%
  filter(lod >= 7.18) %>%
  mutate(local_tx = chr == hot_chr) %>%
  filter(local_tx)
```


```{r make_nonlocal_annot-11}
nonlocal_annot <- dataset.islet.rnaseq$lod.peaks %>%
  filter(chrom == hot_chr, pos <= hot_upper, pos >= hot_lower) %>%
  left_join(y = dataset.islet.rnaseq$annots, by = c("annot.id" = "gene_id")) %>%
  filter(!duplicated(annot.id)) %>%
  filter(lod >= 7.18) %>% #genomewide threshold
  mutate(local_tx = chr == hot_chr) %>%
  filter(!local_tx) %>% 
  filter(!is.na(hotspot))
```


```{r, make_local_annot2-11}
local_annot2 <- local_annot %>%
  filter(middle <= hot_upper + 5, middle >= hot_lower - 5) %>%
  arrange(desc(lod))
```

```{r subset_expr_matrix-11}
hot_local <- dataset.islet.rnaseq$expr[, colnames(dataset.islet.rnaseq$expr) %in% local_annot2$annot.id]
hot_nonlocal <- dataset.islet.rnaseq$expr[, colnames(dataset.islet.rnaseq$expr) %in% nonlocal_annot$annot.id]
nnonlocal <- ncol(hot_nonlocal)
nlocal <- ncol(hot_local)
```




```{r tabulate-11, message=FALSE, warning = FALSE}
med_tib <- med_list %>%
  purrr::map(bind_rows) %>%
  bind_rows() %>%
  as_tibble() %>%
  rename(lod_without_med = lod_no_med, lod_with_med = lod_med) %>%
  mutate(lod_diff = lod_without_med - lod_with_med, lod_diff_proportion = lod_diff / lod_without_med) %>%
  mutate(local_gene_id = rep(colnames(hot_local), each = nnonlocal), nonlocal_gene_id = rep(colnames(hot_nonlocal), times = nlocal)) %>%
  left_join(local_annot2, by = c("local_gene_id" = "annot.id")) %>%
  left_join(nonlocal_annot, by = c("nonlocal_gene_id" = "annot.id")) %>%
  dplyr::select(symbol.x, symbol.y, lod_without_med, lod_with_med, lod_diff, lod_diff_proportion, local_gene_id, nonlocal_gene_id) %>%
  rename(local_symbol = symbol.x, nonlocal_symbol = symbol.y)
```






```{r make_pleio_tib-11}
hot_annot <- local_annot2 %>%
  bind_rows(nonlocal_annot) %>%
  select(annot.id, symbol)
(pleio_tib <- pleio_mixed_list %>%
  purrr::map(.f = function(x) rename(x, gene1_id = local_gene_id, gene2_id = nonlocal_gene_id)) %>%
  c(pleio_local_list, pleio_nonlocal_list) %>%
  bind_rows() %>%
  rename(pleiotropy_lod = lod) %>%
  left_join(hot_annot, by = c("gene1_id" = "annot.id")) %>%
  rename(gene1_symbol = symbol) %>%
  left_join(hot_annot, by = c("gene2_id" = "annot.id")) %>%
  rename(gene2_symbol = symbol) %>%
  select(gene1_symbol, gene2_symbol, pleiotropy_lod)
)  
```

```{r make_pm-11}
pm <- pleio_tib %>%
  tibble_to_matrix(symmetric = TRUE)
```



## heatmaps for full matrix

```{r make_scols-11}
scols <- 1L + (rownames(pm) %in% local_annot2$symbol)
```

```{r heat-pleio-11}
heatmaply(pm, symm = TRUE, cexRow = 0.2, cexCol = 0.2, row_side_colors = scols)
```


```{r heat2-11}
heatmaply(pm, cexRow = 0.2, cexCol = 0.2, seriate = "mean", symm = TRUE, row_side_colors = scols)
```

```{r heat3-11}
(pm > pleio_threshold) %>%
  apply(FUN = as.integer, MARGIN = 2) %>%
  (function(x) {rownames(x) <- colnames(x); return(x)}) %>%
  heatmaply(cexRow = 0.2, cexCol = 0.2, symm = TRUE, row_side_colors = scols)
```

```{r heat4-11}
(pm > pleio_threshold) %>%
  apply(FUN = as.integer, MARGIN = 2) %>%
  (function(x) {rownames(x) <- colnames(x); return(x)}) %>%
  heatmaply(cexRow = 0.2, cexCol = 0.2, symm = TRUE, seriate = "mean", row_side_colors = scols)
```


## Heatmaps for matrix containing only nonlocal traits

```{r heat5-11}
pm_nonlocal <- pleio_tib %>%
  filter(gene1_symbol %in% nonlocal_annot$symbol, gene2_symbol %in% nonlocal_annot$symbol) %>%
  tibble_to_matrix(symmetric = TRUE)
pm_nonlocal %>%
  heatmaply(symm = TRUE, cexRow = 0.3, cexCol = 0.3)

```

```{r heat6-11}
(pm_nonlocal > pleio_threshold) %>%
  apply(FUN = as.integer, MARGIN = 2) %>%
  (function(x) {rownames(x) <- colnames(x); return(x)}) %>%
  heatmaply(symm = TRUE, cexRow = 0.3, cexCol = 0.3)
```



# Chr 13

```{r setup_continued-13}
hot_chr <- 13
hot_mid <- 112.5
```

```{r more_setup-13}
hot_lower <- hot_mid - 2
hot_upper <- hot_mid + 2
fp <- paste0("../figures/Chr", hot_chr, "-")
knitr::opts_chunk$set(fig.path = fp)
```

## Reading intermediate result files 

Let's examine the Chr `r hot_chr` files for pleiotropy results.

```{r readRDS-13}
pleio_mixed_list <- readRDS(paste0("_cache/Chr", hot_chr, "_pleio.rds"))
pleio_local_list <- readRDS(paste0("_cache/Chr", hot_chr, "_pleio_local.rds"))
pleio_nonlocal_list <- readRDS(paste0("_cache/Chr", hot_chr, "_pleio_nonlocal.rds"))
med_list <- readRDS(paste0("_cache/Chr", hot_chr, "_mediations.rds"))
```



```{r make_local_annot-13}
local_annot <- dataset.islet.rnaseq$lod.peaks %>%
  filter(chrom == hot_chr, pos <= hot_upper, pos >= hot_lower) %>%
  left_join(y = dataset.islet.rnaseq$annots, by = c("annot.id" = "gene_id")) %>%
  filter(!duplicated(annot.id)) %>%
  filter(lod >= 7.18) %>%
  mutate(local_tx = chr == hot_chr) %>%
  filter(local_tx)
```


```{r make_nonlocal_annot-13}
nonlocal_annot <- dataset.islet.rnaseq$lod.peaks %>%
  filter(chrom == hot_chr, pos <= hot_upper, pos >= hot_lower) %>%
  left_join(y = dataset.islet.rnaseq$annots, by = c("annot.id" = "gene_id")) %>%
  filter(!duplicated(annot.id)) %>%
  filter(lod >= 7.18) %>% #genomewide threshold
  mutate(local_tx = chr == hot_chr) %>%
  filter(!local_tx) %>% 
  filter(!is.na(hotspot))
```


```{r, make_local_annot2-13}
local_annot2 <- local_annot %>%
  filter(middle <= hot_upper + 5, middle >= hot_lower - 5) %>%
  arrange(desc(lod))
```

```{r subset_expr_matrix-13}
hot_local <- dataset.islet.rnaseq$expr[, colnames(dataset.islet.rnaseq$expr) %in% local_annot2$annot.id]
hot_nonlocal <- dataset.islet.rnaseq$expr[, colnames(dataset.islet.rnaseq$expr) %in% nonlocal_annot$annot.id]
nnonlocal <- ncol(hot_nonlocal)
nlocal <- ncol(hot_local)
```




```{r tabulate-13, message=FALSE, warning = FALSE}
med_tib <- med_list %>%
  purrr::map(bind_rows) %>%
  bind_rows() %>%
  as_tibble() %>%
  rename(lod_without_med = lod_no_med, lod_with_med = lod_med) %>%
  mutate(lod_diff = lod_without_med - lod_with_med, lod_diff_proportion = lod_diff / lod_without_med) %>%
  mutate(local_gene_id = rep(colnames(hot_local), each = nnonlocal), nonlocal_gene_id = rep(colnames(hot_nonlocal), times = nlocal)) %>%
  left_join(local_annot2, by = c("local_gene_id" = "annot.id")) %>%
  left_join(nonlocal_annot, by = c("nonlocal_gene_id" = "annot.id")) %>%
  dplyr::select(symbol.x, symbol.y, lod_without_med, lod_with_med, lod_diff, lod_diff_proportion, local_gene_id, nonlocal_gene_id) %>%
  rename(local_symbol = symbol.x, nonlocal_symbol = symbol.y)
```






```{r make_pleio_tib-13}
hot_annot <- local_annot2 %>%
  bind_rows(nonlocal_annot) %>%
  select(annot.id, symbol)
(pleio_tib <- pleio_mixed_list %>%
  purrr::map(.f = function(x) rename(x, gene1_id = local_gene_id, gene2_id = nonlocal_gene_id)) %>%
  c(pleio_local_list, pleio_nonlocal_list) %>%
  bind_rows() %>%
  rename(pleiotropy_lod = lod) %>%
  left_join(hot_annot, by = c("gene1_id" = "annot.id")) %>%
  rename(gene1_symbol = symbol) %>%
  left_join(hot_annot, by = c("gene2_id" = "annot.id")) %>%
  rename(gene2_symbol = symbol) %>%
  select(gene1_symbol, gene2_symbol, pleiotropy_lod)
)  
```

```{r make_pm-13}
pm <- pleio_tib %>%
  tibble_to_matrix(symmetric = TRUE)
```

## heatmaps for full matrix

```{r make_scols-13}
scols <- 1L + (rownames(pm) %in% local_annot2$symbol)
```

```{r heat-pleio-13}
heatmaply(pm, symm = TRUE, cexRow = 0.2, cexCol = 0.2, row_side_colors = scols)
```


```{r heat2-13}
heatmaply(pm, cexRow = 0.2, cexCol = 0.2, seriate = "mean", symm = TRUE, row_side_colors = scols)
```

```{r heat3-13}
(pm > pleio_threshold) %>%
  apply(FUN = as.integer, MARGIN = 2) %>%
  (function(x) {rownames(x) <- colnames(x); return(x)}) %>%
  heatmaply(cexRow = 0.2, cexCol = 0.2, symm = TRUE, row_side_colors = scols)
```

```{r heat4-13}
(pm > pleio_threshold) %>%
  apply(FUN = as.integer, MARGIN = 2) %>%
  (function(x) {rownames(x) <- colnames(x); return(x)}) %>%
  heatmaply(cexRow = 0.2, cexCol = 0.2, symm = TRUE, seriate = "mean", row_side_colors = scols)
```


## Heatmaps for matrix containing only nonlocal traits

```{r heat5-13}
pm_nonlocal <- pleio_tib %>%
  filter(gene1_symbol %in% nonlocal_annot$symbol, gene2_symbol %in% nonlocal_annot$symbol) %>%
  tibble_to_matrix(symmetric = TRUE)
pm_nonlocal %>%
  heatmaply(symm = TRUE, cexRow = 0.3, cexCol = 0.3)
```

```{r heat6-13}
(pm_nonlocal > pleio_threshold) %>%
  apply(FUN = as.integer, MARGIN = 2) %>%
  heatmaply(symm = TRUE, cexRow = 0.3, cexCol = 0.3)
```

