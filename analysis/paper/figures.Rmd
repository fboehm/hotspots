---
title: "Heatmaps of pleiotropy test statistics"
author: "Frederick Boehm"
date: "7/17/2019"
output: 
  html_document:
    toc: true
    code_folding: hide
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(hotspots)
pleio_threshold <- 4
ult <- 15 # univariate lod threshold
```

Below, we produce heatmaps for every hotspot. We consider, for every hotspot, all local traits with univariate LOD at least `r ult` and all nonlocal traits. Note that the choice of `r ult` is arbitrary and limits the sets of traits to those that are rather strongly associated.







# Chr 2

```{r setup_continued-2}
hot_chr <- 2
hot_mid <- 165.5
keller_mediator <- "Hnf4a"
```

```{r more_setup-2}
hot_lower <- hot_mid - 2
hot_upper <- hot_mid + 2
fp <- paste0("../figures/Chr", hot_chr, "-")
knitr::opts_chunk$set(fig.path = fp)
```




## Reading intermediate result files 

Let's examine the Chr `r hot_chr` files for pleiotropy results.

```{r readRDS-2}
pleio_mixed_list <- readRDS(paste0("_cache/Chr", hot_chr, "_pleio.rds"))
pleio_local_list <- readRDS(paste0("_cache/Chr", hot_chr, "_pleio_local.rds"))
pleio_nonlocal_list <- readRDS(paste0("_cache/Chr", hot_chr, "_pleio_nonlocal.rds"))
med_list <- readRDS(paste0("_cache/Chr", hot_chr, "_mediations.rds"))
```

```{r, load_attie}
load("~/Box Sync/attie/keller2018-chr2-hotspot-chtc/data-to-ignore/Attie_DO378_eQTL_viewer_v1.Rdata")
library(tidyverse)
options(tibble.print_max = 50, tibble.print_min = 20)
```


```{r make_local_annot-2}
local_annot <- dataset.islet.rnaseq$lod.peaks %>%
  filter(chrom == hot_chr, pos <= hot_upper, pos >= hot_lower) %>%
  left_join(y = dataset.islet.rnaseq$annots, by = c("annot.id" = "gene_id")) %>%
  filter(!duplicated(annot.id)) %>%
  filter(lod >= ult) %>%
  mutate(local_tx = chr == hot_chr) %>%
  filter(local_tx)
```


```{r make_nonlocal_annot-2}
nonlocal_annot <- dataset.islet.rnaseq$lod.peaks %>%
  filter(chrom == hot_chr, pos <= hot_upper, pos >= hot_lower) %>%
  inner_join(y = dataset.islet.rnaseq$annots, by = c("annot.id" = "gene_id")) %>%
  filter(!duplicated(annot.id)) %>%
  filter(lod >= 7.18) %>%
  mutate(local_tx = chr == hot_chr) %>%
  filter(!local_tx) %>% 
  filter(!is.na(hotspot))
```


```{r, make_local_annot2-2}
local_annot2 <- local_annot %>%
  filter(middle <= hot_upper + 5, middle >= hot_lower - 5) %>%
  arrange(desc(lod))
```

```{r subset_expr_matrix-2}
hot_local <- dataset.islet.rnaseq$expr[, colnames(dataset.islet.rnaseq$expr) %in% local_annot2$annot.id]
hot_nonlocal <- dataset.islet.rnaseq$expr[, colnames(dataset.islet.rnaseq$expr) %in% nonlocal_annot$annot.id]
nnonlocal <- nrow(nonlocal_annot)
nlocal <- nrow(local_annot2)
```




```{r tabulate-2, message=FALSE, warning = FALSE}
med_tib <- med_list %>%
  purrr::map(bind_rows) %>%
  bind_rows() %>%
  as_tibble() %>%
  rename(lod_without_med = lod_no_med, lod_with_med = lod_med) %>%
  mutate(lod_diff = lod_without_med - lod_with_med, lod_diff_proportion = lod_diff / lod_without_med) %>%
  left_join(local_annot2, by = c("local_gene_id" = "annot.id")) %>%
  left_join(nonlocal_annot, by = c("nonlocal_gene_id" = "annot.id")) %>%
  dplyr::select(symbol.x, symbol.y, lod_without_med, lod_with_med, lod_diff, lod_diff_proportion, local_gene_id, nonlocal_gene_id) %>%
  rename(local_symbol = symbol.x, nonlocal_symbol = symbol.y) %>%
  filter(!is.na(local_symbol))
```






```{r make_pleio_tib-2}
hot_annot <- local_annot2 %>%
  bind_rows(nonlocal_annot) %>%
  dplyr::select(annot.id, symbol)
(pleio_tib <- pleio_mixed_list %>%
  purrr::map(.f = function(x) rename(x, gene1_id = local_gene_id, gene2_id = nonlocal_gene_id)) %>%
  c(pleio_local_list, pleio_nonlocal_list) %>%
  bind_rows() %>%
  rename(pleiotropy_lod = lod) %>%
  inner_join(hot_annot, by = c("gene1_id" = "annot.id")) %>%
  rename(gene1_symbol = symbol) %>%
  inner_join(hot_annot, by = c("gene2_id" = "annot.id")) %>%
  rename(gene2_symbol = symbol) %>%
  dplyr::select(gene1_symbol, gene2_symbol, pleiotropy_lod)
)  
```

```{r make_pm-2}
pm <- pleio_tib %>%
  tibble_to_matrix(symmetric = TRUE)
```


```{r scatter-2}
p <- pleio_mixed_list %>%
  bind_rows() %>%
  rename(pleiotropy_lod = lod) %>%
  inner_join(med_tib, by = c("local_gene_id", "nonlocal_gene_id")) %>%
  dplyr::select(local_symbol, nonlocal_symbol, pleiotropy_lod, lod_diff, lod_diff_proportion, lod_without_med, lod_with_med, filename, nonlocal_gene_id, local_gene_id) %>%
  ggplot() + geom_point(mapping = aes(x = pleiotropy_lod, y = lod_diff, colour = local_symbol == keller_mediator, nonlocal = nonlocal_symbol), size = 0.05) + theme(legend.position = "none") + xlab("Pleiotropy LOD") + ylab("Mediation LOD difference")
fnsvg <- paste0("Chr", hot_chr, "_scatter.svg")
fnpdf <- paste0("Chr", hot_chr, "_scatter.pdf")
ggsave(plot = p, filename = file.path("../figures", fnsvg))
ggsave(plot = p, filename = file.path("../figures", fnpdf))
```

```{r, scatter_by_local-2}
p <- pleio_mixed_list %>%
  bind_rows() %>%
  rename(pleiotropy_lod = lod) %>%
  inner_join(med_tib, by = c("local_gene_id", "nonlocal_gene_id")) %>%
  dplyr::select(local_symbol, nonlocal_symbol, pleiotropy_lod, lod_diff, lod_diff_proportion, lod_without_med, lod_with_med, filename, nonlocal_gene_id, local_gene_id) %>%
  ggplot() + 
  geom_point(mapping = aes(x = pleiotropy_lod, y = lod_diff, colour = nonlocal_symbol, nonlocal = nonlocal_symbol), size = 0.1) + 
  facet_wrap(. ~ local_symbol, nrow = ceiling(nlocal / 2), ncol = 2) +
  broman::karl_theme(strip.placement = "inside") + 
  theme(legend.position = "none") +
  xlab("Pleiotropy LOD") + 
  ylab("Mediation LOD difference")
fnsvg <- paste0("Chr", hot_chr, "_scatter-panel.svg")
fnpdf <- paste0("Chr", hot_chr, "_scatter-panel.pdf")
ggsave(plot = p, filename = file.path("../figures", fnsvg), height = ceiling(nlocal / 2))
ggsave(plot = p, filename = file.path("../figures", fnpdf), height = ceiling(nlocal / 2))
```


## heatmaps for full matrix


```{r load_heatmaply}
library(heatmaply)
```

```{r make_scols-2}
scols1 <- 1L + (rownames(pm) %in% local_annot2$symbol)
scols2 <- rownames(pm) %in% (med_tib %>% filter(local_symbol == keller_mediator, lod_diff > 1.5))$nonlocal_symbol
```


The vignette for `heatmaply` is quite helpful and includes discussion of its methods for ordering rows. For a discussion of ordering of rows in `heatmaply`, see this issue & its comments: <https://github.com/talgalili/heatmaply/issues/153>



```{r heat8-2}
# order the nonlocal traits first
## indicator for being a nonlocal trait
indic_nonlocal <- rownames(pm) %in% nonlocal_annot$symbol
# define ord_nonlocal
ord_nonlocal <- pm[indic_nonlocal, indic_nonlocal] %>%
  dist() %>%
  hclust() %>%
  as.dendrogram() %>%
  dendextend::seriate_dendrogram(dist(pm[indic_nonlocal, indic_nonlocal])) %>%
  order.dendrogram()
rn_nonlocal <- rownames(pm[indic_nonlocal, indic_nonlocal][ord_nonlocal, ord_nonlocal])
# define ord_local
ord_local<- pm[!indic_nonlocal, !indic_nonlocal] %>%
  dist() %>%
  hclust() %>%
  as.dendrogram() %>%
  dendextend::seriate_dendrogram(dist(pm[!indic_nonlocal, !indic_nonlocal])) %>%
  order.dendrogram()
rn_local <- rownames(pm[!indic_nonlocal, !indic_nonlocal][ord_local, ord_local])
rn <- c(rn_nonlocal, rn_local)
```



```{r make_scols-extra-2}
scols_extra <- purrr::map(.x = local_annot2$symbol, 
                          .f = function(x) {rownames(pm) %in% (med_tib %>% filter(local_symbol == x, lod_diff > 1.5))$nonlocal_symbol}
) %>% 
  bind_cols() %>%
  (function(x){colnames(x) <- local_annot2$symbol; x}) %>%
  mutate(local = scols1)
```

Instead of adding a column for *every* local trait, let's only add a column for those local traits that mediate at least, say, 4 traits at the 1.5 LOD difference value.

```{r count_med}
n_med_tr <- 4 # arbitrary threshold
(n_med_per_local <- med_tib %>%
  group_by(local_symbol) %>%
  filter(lod_diff > 1.5) %>%
  count() %>%
  filter(n >= n_med_tr)
  )
scols_pre <- scols_extra %>%
  dplyr::select(n_med_per_local$local_symbol)
# get ordering for columns of scols_pre
col_order <- scols_pre %>%
  t() %>%
  dist() %>%
  hclust() %>%
  as.dendrogram() %>%
  dendextend::seriate_dendrogram(dist(t(scols_pre))) %>%
  order.dendrogram()
scols <- scols_pre[ , col_order] %>%
  mutate(local = scols1)
```

```{r heat9-2}
ord <- match(rn, rownames(pm))

pm[ord, ord] %>%
  apply(FUN = hotspots::trunc2, MARGIN = 2, threshold = 5) %>%
  heatmaply(Rowv = FALSE, 
            Colv = FALSE, 
            cexRow = 0.2, 
            cexCol = 0.2, 
            symm = TRUE, 
            row_side_colors = scols[ord, ],
            col_side_colors = scols1[ord],
            limits = c(0, 5)
            )
```


## Scatter: index v QTL peak position

```{r index-v-peak-position-2}
tibble(symbol = rownames(pm[indic_nonlocal, indic_nonlocal])[ord_nonlocal], index = 1:length(symbol)) %>%
  left_join(nonlocal_annot, by = "symbol") %>%
  ggplot() + geom_point(aes(y = pos, x = index))
```





# Chr 5

```{r setup_continued-5}
hot_chr <- 5
hot_mid <- 146
keller_mediator <- "Pdx1"
```

```{r more_setup-5, ref.label = "more_setup-2"}
```

## Reading intermediate result files 


```{r readRDS-5, ref.label="readRDS-2"}
```



```{r make_local_annot-5, ref.label="make_local_annot-2"}
```


```{r make_nonlocal_annot-5, ref.label = "make_nonlocal_annot-2"}
```


```{r, make_local_annot2-5, ref.label = "make_local_annot2-2"}
```

```{r subset_expr_matrix-5, ref.label = "subset_expr_matrix-2"}
```




```{r tabulate-5, ref.label = "tabulate-2", message=FALSE, warning = FALSE}
```






```{r make_pleio_tib-5, ref.label="make_pleio_tib-2"}
```


```{r make_pm-5, ref.label = "make_pm-2"}
```

```{r scatter-5, ref.label="scatter-2"}
```

```{r, ref.label = "scatter_by_local-2"}
```


## heatmaps for full matrix

```{r make_scols-5, ref.label="make_scols-2"}
```



```{r heat8-5, ref.label="heat8-2"}
```

```{r ref.label = "make_scols-extra-2"}
```

```{r ref.label = "count_med"}
```


```{r ref.label = "heat9-2"}
```

## Scatter: index v QTL peak position

```{r ref.label = "index-v-peak-position-2"}
```



# Chr 7

```{r setup_continued-7}
hot_chr <- 7
hot_mid <- 46
keller_mediator <- "Fam83e"
```

```{r ref.label = "more_setup-2"}
```

## Reading intermediate result files 


```{r ref.label="readRDS-2"}
```



```{r ref.label="make_local_annot-2"}
```


```{r ref.label = "make_nonlocal_annot-2"}
```


```{r ref.label = "make_local_annot2-2"}
```

```{r ref.label = "subset_expr_matrix-2"}
```




```{r ref.label = "tabulate-2", message=FALSE, warning = FALSE}
```






```{r ref.label="make_pleio_tib-2"}
```


```{r ref.label = "make_pm-2"}
```


```{r scatter-7, ref.label="scatter-2"}
```



```{r, ref.label = "scatter_by_local-2"}
```


## heatmaps for full matrix

```{r ref.label="make_scols-2"}
```



```{r ref.label="heat8-2"}
```

```{r ref.label = "make_scols-extra-2"}
```

```{r ref.label = "count_med"}
```



```{r ref.label = "heat9-2"}
```



## Scatter: index v QTL peak position

```{r ref.label = "index-v-peak-position-2"}
```



# Chr 11

```{r setup_continued-11}
hot_chr <- 11
hot_mid <- 71
keller_mediator <- "Sat2"
```

```{r ref.label = "more_setup-2"}
```

## Reading intermediate result files 


```{r ref.label="readRDS-2"}
```



```{r ref.label="make_local_annot-2"}
```


```{r ref.label = "make_nonlocal_annot-2"}
```


```{r ref.label = "make_local_annot2-2"}
```

```{r ref.label = "subset_expr_matrix-2"}
```




```{r ref.label = "tabulate-2", message=FALSE, warning = FALSE}
```






```{r ref.label="make_pleio_tib-2"}
```


```{r ref.label = "make_pm-2"}
```


```{r scatter-11, ref.label="scatter-2"}
```


```{r, ref.label = "scatter_by_local-2"}
```


## heatmaps for full matrix

```{r ref.label="make_scols-2"}
```



```{r ref.label="heat8-2"}
```

```{r ref.label = "make_scols-extra-2"}
```


```{r ref.label = "count_med"}
```



```{r ref.label = "heat9-2"}
```


## Scatter: index v QTL peak position

```{r ref.label = "index-v-peak-position-2"}
```



# Chr 13

```{r setup_continued-13}
hot_chr <- 13
hot_mid <- 112.5
keller_mediator <- "Il6st"
```

```{r ref.label = "more_setup-2"}
```

## Reading intermediate result files 


```{r ref.label="readRDS-2"}
```



```{r ref.label="make_local_annot-2"}
```


```{r ref.label = "make_nonlocal_annot-2"}
```


```{r ref.label = "make_local_annot2-2"}
```

```{r ref.label = "subset_expr_matrix-2"}
```




```{r ref.label = "tabulate-2", message=FALSE, warning = FALSE}
```






```{r ref.label="make_pleio_tib-2"}
```


```{r ref.label = "make_pm-2"}
```


```{r scatter-13, ref.label="scatter-2"}
```



```{r, ref.label = "scatter_by_local-2"}
```



## heatmaps for full matrix

```{r ref.label="make_scols-2"}
```



```{r ref.label="heat8-2"}
```

```{r ref.label = "make_scols-extra-2"}
```

```{r ref.label = "count_med"}
```



```{r ref.label = "heat9-2"}
```

## Scatter: index v QTL peak position

```{r ref.label = "index-v-peak-position-2"}
```
